<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Portfolio Allocator & Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .btn { transition: all 0.2s; }
        .btn:hover { transform: translateY(-1px); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app" class="container mx-auto p-4 max-w-6xl">

    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-chart-pie text-blue-600"></i> AI Portfolio Allocator</h1>
        <div class="flex gap-2 w-full md:w-auto">
            <input v-if="showApiKeyInput" type="password" v-model="tempApiKey" placeholder="Incolla API Key Gemini" class="border p-2 rounded flex-grow md:flex-grow-0">
            <button @click="saveApiKey" class="bg-gray-800 text-white px-4 py-2 rounded btn whitespace-nowrap">
                {{ hasApiKey ? 'Chiave Salvata (Resetta)' : 'Salva API Key' }}
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">1. Gestione Team</h2>
                <span class="text-sm bg-blue-100 text-blue-800 py-1 px-2 rounded">Tot LM: {{ totalLoanManagers }}</span>
            </div>
            
            <div class="space-y-3 max-h-64 overflow-y-auto pr-2 custom-scroll">
                <div v-for="(team, index) in teams" :key="index" class="flex gap-2 items-end bg-gray-50 p-3 rounded border">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500">Team Leader</label>
                        <input type="text" v-model="team.leader" class="w-full border p-1 rounded font-semibold" placeholder="Nome TL">
                    </div>
                    <div class="w-24">
                        <label class="text-xs text-gray-500">N. LM</label>
                        <input type="number" v-model="team.managers" class="w-full border p-1 rounded" min="1">
                    </div>
                    <button @click="removeTeam(index)" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            <button @click="addTeam" class="mt-4 w-full bg-blue-500 text-white py-2 rounded btn"><i class="fas fa-plus"></i> Aggiungi Team</button>
        </div>

        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">2. Portafogli</h2>
                <div>
                    <input type="file" ref="fileInput" @change="handleFileUpload" class="hidden" accept=".csv, .xlsx, .xls">
                    <button @click="$refs.fileInput.click()" class="bg-green-600 text-white px-3 py-1 rounded text-sm btn mr-2">
                        <i class="fas fa-file-excel"></i> Importa Excel
                    </button>
                    <button @click="addPortfolio" class="bg-blue-500 text-white px-3 py-1 rounded text-sm btn">
                        <i class="fas fa-plus"></i> Manuale
                    </button>
                </div>
            </div>

            <div class="space-y-3 max-h-64 overflow-y-auto pr-2 custom-scroll">
                <div v-for="(ptf, index) in portfolios" :key="index" class="bg-gray-50 p-3 rounded border relative transition hover:shadow-md">
                    <button @click="removePortfolio(index)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input type="text" v-model="ptf.name" placeholder="Nome Portafoglio" class="border p-1 rounded text-sm font-medium">
                        <input type="text" v-model="ptf.cedant" placeholder="Cedente" class="border p-1 rounded text-sm">
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <input type="number" v-model="ptf.total_cases" placeholder="N. Pratiche" class="border p-1 rounded text-sm">
                        <label class="flex items-center space-x-2 text-sm bg-white p-1 rounded border">
                            <input type="checkbox" v-model="ptf.is_new" class="form-checkbox text-blue-600">
                            <span>Nuovo?</span>
                        </label>
                    </div>
                    <input type="text" v-model="ptf.status_string" placeholder="Status (es: Attive: 100, Chiuse: 50)" class="w-full border p-1 rounded text-sm text-gray-600">
                </div>
            </div>
        </div>
    </div>

    <div class="text-center my-6">
        <button @click="calculateAssignment" :disabled="loading || !hasApiKey" class="bg-indigo-600 text-white px-8 py-3 rounded-lg text-xl font-bold shadow-lg btn flex items-center justify-center mx-auto gap-3 disabled:opacity-50 disabled:cursor-not-allowed">
            <span v-if="!loading"><i class="fas fa-brain"></i> Calcola Assegnazione e Grafici</span>
            <span v-else class="loader"></span>
            <span v-if="loading">Analisi AI in corso...</span>
        </button>
    </div>

    <div v-if="result" class="animate-fade-in">
        
        <div class="card bg-gray-50 border border-gray-200">
            <h3 class="text-lg font-bold text-gray-700 mb-4 border-b pb-2">ðŸ“Š Dashboard Carico & Distribuzione</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="h-64 relative">
                    <canvas id="chartWorkload"></canvas>
                </div>
                <div class="h-64 relative">
                    <canvas id="chartDistribution"></canvas>
                </div>
            </div>
            <div class="mt-4 text-center text-sm text-gray-500 italic">
                Il grafico a barre mostra la media pratiche per singola risorsa (LM) in ogni team. L'obiettivo Ã¨ livellare queste barre.
            </div>
        </div>

        <div class="card border-t-4 border-green-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Dettaglio Assegnazioni</h2>
                <button @click="exportToExcel" class="bg-green-700 text-white px-4 py-2 rounded btn">
                    <i class="fas fa-download"></i> Scarica Excel
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg border">
                <table class="min-w-full bg-white text-sm">
                    <thead class="bg-gray-100 text-gray-700 uppercase">
                        <tr>
                            <th class="py-3 px-4 border-b text-left">Team Leader</th>
                            <th class="py-3 px-4 border-b text-left">Portafoglio</th>
                            <th class="py-3 px-4 border-b text-left">Cedente</th>
                            <th class="py-3 px-4 border-b text-center">Tipo</th>
                            <th class="py-3 px-4 border-b text-right">Pratiche Tot</th>
                            <th class="py-3 px-4 border-b text-right bg-blue-50">Pratiche/LM</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(row, idx) in result.assignments" :key="idx" class="hover:bg-gray-50 border-b last:border-0">
                            <td class="py-2 px-4 font-semibold text-indigo-700">{{ row.team_leader }}</td>
                            <td class="py-2 px-4">{{ row.portfolio_name }}</td>
                            <td class="py-2 px-4">{{ row.cedant }}</td>
                            <td class="py-2 px-4 text-center">
                                <span v-if="row.is_new" class="bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full text-xs font-bold shadow-sm">NUOVO</span>
                                <span v-else class="text-gray-400 text-xs">-</span>
                            </td>
                            <td class="py-2 px-4 text-right font-mono">{{ row.cases }}</td>
                            <td class="py-2 px-4 text-right font-mono font-bold bg-blue-50 text-blue-800">{{ row.cases_per_lm }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-6 p-4 bg-yellow-50 rounded border border-yellow-200">
                <h3 class="font-bold text-yellow-800 mb-2"><i class="fas fa-lightbulb"></i> Logica dell'AI:</h3>
                <p class="text-sm text-gray-800 whitespace-pre-line leading-relaxed">{{ result.reasoning }}</p>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                apiKey: localStorage.getItem('gemini_api_key') || '',
                tempApiKey: '',
                showApiKeyInput: !localStorage.getItem('gemini_api_key'),
                loading: false,
                // Dati di esempio
                teams: [
                    { leader: 'Rossi', managers: 4 },
                    { leader: 'Bianchi', managers: 3 },
                    { leader: 'Verdi', managers: 2 }
                ],
                portfolios: [
                    { name: 'Alpha 23', cedant: 'Banca A', total_cases: 800, is_new: false, status_string: '' },
                    { name: 'Beta New', cedant: 'Banca B', total_cases: 450, is_new: true, status_string: '' },
                    { name: 'Gamma 22', cedant: 'Banca A', total_cases: 300, is_new: false, status_string: '' },
                    { name: 'Delta Legacy', cedant: 'Banca C', total_cases: 600, is_new: false, status_string: '' },
                    { name: 'Epsilon', cedant: 'Banca B', total_cases: 200, is_new: true, status_string: '' }
                ],
                result: null,
                charts: { workload: null, distribution: null }
            }
        },
        computed: {
            hasApiKey() { return this.apiKey && this.apiKey.length > 10; },
            totalLoanManagers() { return this.teams.reduce((acc, team) => acc + (parseInt(team.managers) || 0), 0); }
        },
        methods: {
            saveApiKey() {
                if (this.hasApiKey) {
                    localStorage.removeItem('gemini_api_key');
                    this.apiKey = '';
                    this.showApiKeyInput = true;
                } else if(this.tempApiKey) {
                    localStorage.setItem('gemini_api_key', this.tempApiKey);
                    this.apiKey = this.tempApiKey;
                    this.showApiKeyInput = false;
                    this.tempApiKey = '';
                }
            },
            addTeam() { this.teams.push({ leader: '', managers: 1 }); },
            removeTeam(i) { this.teams.splice(i, 1); },
            addPortfolio() { this.portfolios.push({ name: '', cedant: '', total_cases: 0, is_new: false, status_string: '' }); },
            removePortfolio(i) { this.portfolios.splice(i, 1); },
            
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    jsonData.forEach(row => {
                        this.portfolios.push({
                            name: row['Nome'] || row['Portafoglio'] || 'Ptf Importato',
                            cedant: row['Cedente'] || 'ND',
                            total_cases: Number(row['Pratiche'] || row['Numero'] || 0),
                            is_new: !!(row['Nuovo']),
                            status_string: row['Status'] || ''
                        });
                    });
                };
                reader.readAsArrayBuffer(file);
            },

            async calculateAssignment() {
                this.loading = true;
                this.result = null;

                const promptData = { teams: this.teams, portfolios: this.portfolios };
                
                // Prompt ottimizzato
                const systemPrompt = `
                    Agisci come un algoritmo di allocazione portafogli.
                    INPUT: ${JSON.stringify(promptData)}
                    
                    VINCOLI:
                    1. Assegna TUTTI i portafogli ai Team Leader.
                    2. Raggruppa i portafogli per CEDENTE: stessa cedente = stesso Team (ove possibile).
                    3. EQUITÃ€ CARICO: (Totale Pratiche Team / N. Loan Manager del Team) deve essere simile tra i team.
                    4. DISTRIBUZIONE NUOVI: Assegna portafogli 'is_new' a team diversi se possibile.
                    
                    OUTPUT JSON (NO Markdown):
                    {
                        "assignments": [
                            { "team_leader": "Nome", "portfolio_name": "Nome", "cedant": "Nome", "is_new": true/false, "cases": 123, "cases_per_lm": 123 }
                        ],
                        "reasoning": "Spiegazione sintetica"
                    }
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);

                    let rawText = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
                    this.result = JSON.parse(rawText);

                    // Genera i grafici dopo che il DOM si Ã¨ aggiornato
                    this.$nextTick(() => {
                        this.renderCharts();
                    });

                } catch (error) {
                    alert("Errore AI: " + error.message);
                } finally {
                    this.loading = false;
                }
            },

            renderCharts() {
                if (!this.result) return;

                // 1. Aggregazione Dati per Team
                const teamStats = {};
                
                // Inizializza stats basandosi sui team originali per assicurarsi che appaiano tutti
                this.teams.forEach(t => {
                    teamStats[t.leader] = { total_cases: 0, managers: parseInt(t.managers) || 1, load_per_lm: 0 };
                });

                // Somma le pratiche assegnate
                this.result.assignments.forEach(a => {
                    // Normalizzazione nome (in caso l'AI faccia piccoli typo)
                    const key = Object.keys(teamStats).find(k => k.toLowerCase() === a.team_leader.toLowerCase()) || a.team_leader;
                    if (!teamStats[key]) teamStats[key] = { total_cases: 0, managers: 1 }; // Fallback
                    teamStats[key].total_cases += a.cases;
                });

                // Calcolo metriche finali
                const labels = Object.keys(teamStats);
                const workloadData = labels.map(l => Math.round(teamStats[l].total_cases / teamStats[l].managers));
                const totalData = labels.map(l => teamStats[l].total_cases);

                // Configurazione Colori
                const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];

                // --- Grafico 1: Carico per LM (Barre) ---
                if (this.charts.workload) this.charts.workload.destroy();
                const ctxWorkload = document.getElementById('chartWorkload').getContext('2d');
                this.charts.workload = new Chart(ctxWorkload, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Pratiche medie per Loan Manager',
                            data: workloadData,
                            backgroundColor: 'rgba(79, 70, 229, 0.7)',
                            borderColor: '#4f46e5',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, title: { display: true, text: 'N. Pratiche / LM' } } }
                    }
                });

                // --- Grafico 2: Distribuzione Totale (Ciambella) ---
                if (this.charts.distribution) this.charts.distribution.destroy();
                const ctxDist = document.getElementById('chartDistribution').getContext('2d');
                this.charts.distribution = new Chart(ctxDist, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: totalData,
                            backgroundColor: colors,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom' },
                            title: { display: true, text: 'Pratiche Totali per Team' } 
                        }
                    }
                });
            },

            exportToExcel() {
                if (!this.result) return;
                const ws = XLSX.utils.json_to_sheet(this.result.assignments);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Assegnazioni");
                XLSX.writeFile(wb, "Report_Assegnazione_NPL.xlsx");
            }
        }
    }).mount('#app');
</script>

</body>
</html>
