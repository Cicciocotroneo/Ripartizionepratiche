<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aequo - Smart Allocator v6.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        [v-cloak] { display: none !important; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #6366f1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        
        .tab-btn { padding: 10px 20px; font-weight: bold; border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; cursor: pointer; }
        .tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; background-color: #f8fafc; }
        .tab-btn:hover:not(.active) { color: #334155; border-bottom-color: #cbd5e1; }
    </style>
</head>
<body>

<div id="app" v-cloak class="container mx-auto p-4 max-w-7xl">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-balance-scale text-indigo-600"></i> Aequo <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">v6.0 Macro-Import</span>
            </h1>
        </div>
        
        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto items-center">
            <div v-if="hasApiKey && availableModels.length > 0" class="flex items-center gap-2 text-sm bg-gray-50 p-1 rounded border">
                <i class="fas fa-microchip text-gray-500 ml-2"></i>
                <select v-model="selectedModel" class="bg-transparent border-none outline-none text-gray-700 font-medium cursor-pointer pr-2">
                    <option v-for="m in availableModels" :value="m.name">{{ m.displayName }}</option>
                </select>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <input v-if="!hasApiKey" type="password" v-model="tempApiKey" placeholder="API Key Gemini" class="border border-gray-300 p-2 rounded text-sm flex-grow w-64">
                <button @click="saveApiKey" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-700 transition whitespace-nowrap">
                    {{ hasApiKey ? 'Connesso' : 'Connetti' }}
                </button>
                <button v-if="hasApiKey" @click="resetApiKey" class="text-red-500 hover:text-red-700 px-2 text-sm"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-5 space-y-6">
            <div class="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg px-4 pt-2">
                <button @click="mode = 'macro'" class="tab-btn" :class="{ 'active': mode === 'macro' }"><i class="fas fa-cubes"></i> Macro</button>
                <button @click="mode = 'detail'" class="tab-btn" :class="{ 'active': mode === 'detail' }"><i class="fas fa-list"></i> Dettaglio</button>
            </div>

            <div v-if="mode === 'macro'" class="card border-l-4 border-orange-500 animate-fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Portafogli (Macro)</h2>
                    <div class="flex gap-2">
                        <label class="cursor-pointer bg-green-50 text-green-700 hover:bg-green-100 px-3 py-1 rounded text-sm font-bold border border-green-200 transition flex items-center gap-1">
                            <i class="fas fa-file-excel"></i> Importa Excel
                            <input type="file" @change="handleMacroUpload" class="hidden" accept=".xlsx, .csv">
                        </label>
                        <button @click="addManualPortfolio" class="text-orange-600 font-bold text-sm bg-orange-50 px-3 py-1 rounded border border-orange-200 hover:bg-orange-100"><i class="fas fa-plus"></i> Manuale</button>
                    </div>
                </div>

                <div class="text-xs text-gray-500 mb-3 bg-gray-50 p-2 rounded border">
                    Colonne Excel attese (flessibili):<br>
                    <b>Nome Progetto</b>, <b># NDG</b> (Numero pratiche), <b>Cedente</b>, <b>Tipo</b> (se contiene "Nuovo")
                </div>
                
                <div class="space-y-3 max-h-[300px] overflow-y-auto custom-scroll pr-2">
                    <div v-for="(ptf, idx) in manualPortfolios" :key="idx" class="bg-gray-50 p-3 rounded border relative">
                        <button @click="removeManualPortfolio(idx)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div>
                                <label class="text-[10px] text-gray-400 uppercase">Nome</label>
                                <input type="text" v-model="ptf.name" class="border p-1 rounded text-sm w-full font-semibold">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 uppercase">Cedente</label>
                                <input type="text" v-model="ptf.cedant" class="border p-1 rounded text-sm w-full">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 items-center">
                            <div>
                                <label class="text-[10px] text-gray-400 uppercase">N. Pratiche (NDG)</label>
                                <input type="number" v-model="ptf.cases" class="border p-1 rounded text-sm w-full">
                            </div>
                            <label class="flex items-center space-x-2 text-sm text-gray-600 cursor-pointer mt-3">
                                <input type="checkbox" v-model="ptf.is_new" class="form-checkbox text-orange-500 rounded"> <span>Nuovo?</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div v-if="manualPortfolios.length === 0" class="text-center text-gray-400 text-sm py-4">Nessun portafoglio inserito.</div>
            </div>

            <div v-if="mode === 'detail'" class="card border-l-4 border-blue-500 animate-fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Import Dettaglio (Pratiche)</h2>
                    <span v-if="rawRows.length > 0" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">{{ rawRows.length.toLocaleString() }} Righe</span>
                </div>
                <div class="flex items-center gap-3">
                    <label class="cursor-pointer bg-blue-50 text-blue-700 hover:bg-blue-100 px-4 py-6 w-full border-2 border-dashed border-blue-200 rounded-lg text-center transition">
                        <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i><br>
                        <span class="text-sm font-medium">Carica File Excel</span>
                        <input type="file" @change="handleDetailUpload" class="hidden" accept=".xlsx, .csv">
                    </label>
                </div>
                <div class="mt-3 p-2 bg-gray-50 border border-gray-200 rounded text-xs text-gray-500">
                    <p class="font-bold">Colonne:</p> id, portfolio, status, cedente (ordine flessibile)
                </div>
            </div>

            <div class="card border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Teams</h2>
                    <button @click="addTeam" class="text-indigo-600 font-bold text-sm"><i class="fas fa-plus"></i> Team</button>
                </div>
                <div class="space-y-4 max-h-[300px] overflow-y-auto custom-scroll pr-2">
                    <div v-for="(team, idx) in teams" :key="idx" class="bg-gray-50 p-3 rounded border border-gray-200 relative">
                        <button @click="removeTeam(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        <div class="mb-2">
                            <input type="text" v-model="team.leader" class="w-full font-bold bg-white border border-gray-300 rounded p-1 text-sm" placeholder="Nome Team Leader">
                        </div>
                        <textarea v-model="team.managerInput" @blur="parseManagers(idx)" class="w-full bg-white border border-gray-300 rounded p-2 text-xs h-16 resize-none" placeholder="LM (es: Luca, Marco...)"></textarea>
                        <div class="text-right text-xs text-indigo-600 mt-1 font-bold">{{ team.managers.length }} LM</div>
                    </div>
                </div>
            </div>

            <button @click="calculateAssignment" :disabled="isProcessing || !hasApiKey || (!canProceed) || !selectedModel" 
                class="w-full bg-gradient-to-r from-slate-800 to-black text-white py-4 rounded-lg text-xl font-bold shadow-lg hover:shadow-xl transition disabled:opacity-50 flex items-center justify-center gap-3">
                <span v-if="!isProcessing"><i class="fas fa-brain"></i> Calcola e Bilancia</span>
                <span v-else class="flex items-center gap-2">
                    <span class="loader border-white border-t-transparent"></span>
                    <span class="text-base font-normal">Elaborazione...</span>
                </span>
            </button>
            <div v-if="!selectedModel && hasApiKey" class="text-center text-red-500 text-xs mt-2">Nessun modello trovato.</div>
        </div>

        <div class="lg:col-span-7 space-y-6">
            <div v-if="hasResults" class="card">
                <h3 class="text-gray-700 font-bold mb-4">üìä Bilanciamento Finale (Post-Correzione)</h3>
                <div class="h-64"><canvas id="resultChart"></canvas></div>
                <p class="text-xs text-center text-gray-400 mt-2">Dati reali ricalcolati dopo il bilanciamento automatico.</p>
            </div>

            <div v-if="hasResults" class="card border-t-4 border-green-500 bg-green-50">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-900">Risultato {{ mode === 'macro' ? 'Macro' : 'Dettaglio' }}</h2>
                    <button @click="exportExcel" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold shadow"><i class="fas fa-download"></i> Excel</button>
                </div>
                
                <div v-if="rebalancingLog" class="bg-yellow-50 border border-yellow-200 p-3 rounded mb-4 text-xs text-yellow-800">
                    <strong>‚ö†Ô∏è Intervento 'Robin Hood':</strong><br>
                    <span class="whitespace-pre-line">{{ rebalancingLog }}</span>
                </div>

                <div class="bg-white p-3 rounded border border-green-200 mb-4 text-sm text-gray-700 whitespace-pre-line">
                    <strong class="text-purple-600">Ragionamento AI Iniziale:</strong> {{ aiReasoning }}
                </div>

                <div v-if="mode === 'macro'" class="overflow-x-auto border rounded bg-white">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-600">
                            <tr>
                                <th class="p-3">Team Leader</th>
                                <th class="p-3">Portafoglio</th>
                                <th class="p-3">Cedente</th>
                                <th class="p-3 text-right">Pratiche</th>
                                <th class="p-3 text-center">Nuovo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(row, idx) in macroResults" :key="idx" class="border-b hover:bg-gray-50">
                                <td class="p-3 font-bold text-indigo-700">{{ row.team_leader }}</td>
                                <td class="p-3">{{ row.portfolio_name }}</td>
                                <td class="p-3 text-gray-500">{{ row.cedant }}</td>
                                <td class="p-3 text-right font-mono">{{ row.cases }}</td>
                                <td class="p-3 text-center"><span v-if="row.is_new" class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded font-bold">NEW</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="mode === 'detail'" class="overflow-x-auto border rounded bg-white max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-600 sticky top-0">
                            <tr>
                                <th class="p-3">ID</th>
                                <th class="p-3">Ptf</th>
                                <th class="p-3">Status</th>
                                <th class="p-3 bg-yellow-50">LM</th>
                                <th class="p-3 bg-blue-50">Team</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="row in assignedRows.slice(0, 50)" :key="row.id" class="border-b hover:bg-gray-50">
                                <td class="p-3 font-mono text-xs">{{ row.id }}</td>
                                <td class="p-3">{{ row.ptf }}</td>
                                <td class="p-3">{{ row.status }}</td>
                                <td class="p-3 font-bold bg-yellow-50">{{ row.assignedTo }}</td>
                                <td class="p-3 bg-blue-50">{{ row.team }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="p-2 text-center text-xs text-gray-400">Prime 50 righe mostrate.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    apiKey: localStorage.getItem('aequo_api_key') || '',
                    tempApiKey: '',
                    isProcessing: false,
                    mode: 'macro',
                    availableModels: [],
                    selectedModel: '',
                    
                    teams: [
                        { leader: 'TL1', managerInput: 'LM1, LM2, LM3', managers: ['LM1', 'LM2', 'LM3'] },
                        { leader: 'TL2', managerInput: 'LM4, LM5, LM6', managers: ['LM4', 'LM5', 'LM6'] },
                        { leader: 'TL3', managerInput: 'LM7, LM8, LM9', managers: ['LM7', 'LM8', 'LM9'] }
                    ],
                    
                    manualPortfolios: [
                        { name: 'Ptf Esempio', cedant: 'Bank X', cases: 1000, is_new: true }
                    ],
                    
                    rawRows: [],
                    portfolioStats: [],
                    assignedRows: [],
                    macroResults: [],
                    aiReasoning: '',
                    rebalancingLog: '',
                    chartInstance: null
                }
            },
            computed: {
                hasApiKey() { return this.apiKey && this.apiKey.length > 5; },
                canProceed() { return (this.mode === 'macro' && this.manualPortfolios.length > 0) || (this.mode === 'detail' && this.rawRows.length > 0); },
                hasResults() { return (this.mode === 'macro' && this.macroResults.length > 0) || (this.mode === 'detail' && this.assignedRows.length > 0); },
                selectedModelShort() { return this.selectedModel ? this.selectedModel.split('/').pop().replace('gemini-', '').replace('-latest', '') : ''; }
            },
            watch: {
                mode() { this.resetResults(); }
            },
            mounted() { if(this.hasApiKey) this.fetchModels(); },
            methods: {
                resetResults() { this.macroResults=[]; this.assignedRows=[]; this.aiReasoning=''; this.rebalancingLog=''; if(this.chartInstance) { this.chartInstance.destroy(); this.chartInstance = null; } },
                async saveApiKey() { if(this.tempApiKey) { localStorage.setItem('aequo_api_key', this.tempApiKey); this.apiKey = this.tempApiKey; this.tempApiKey = ''; await this.fetchModels(); } },
                resetApiKey() { localStorage.removeItem('aequo_api_key'); this.apiKey = ''; this.availableModels = []; this.selectedModel = ''; },
                
                async fetchModels() {
                    try {
                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${this.apiKey}`);
                        const d = await r.json();
                        const gemini = d.models.filter(m => m.name.includes('gemini') && m.supportedGenerationMethods.includes('generateContent'));
                        this.availableModels = gemini.map(m => ({ name: m.name, displayName: m.displayName || m.name.split('/').pop() }));
                        let best = this.availableModels.find(m => m.name.includes('flash-latest')) || this.availableModels.find(m => m.name.includes('flash')) || this.availableModels[0];
                        if(best) this.selectedModel = best.name;
                    } catch(e) { alert("Errore Key: "+e.message); this.resetApiKey(); }
                },

                addTeam() { this.teams.push({ leader: '', managerInput: '', managers: ['LM1'] }); },
                removeTeam(i) { this.teams.splice(i,1); },
                parseManagers(i) {
                    const raw = this.teams[i].managerInput;
                    this.teams[i].managers = (raw && raw.trim()) ? raw.split(/,|\n/).map(n=>n.trim()).filter(n=>n.length>0) : ['LM1'];
                },

                addManualPortfolio() { this.manualPortfolios.push({ name: '', cedant: '', cases: 0, is_new: false }); },
                removeManualPortfolio(i) { this.manualPortfolios.splice(i,1); },

                // --- UPLOAD PER MACRO MODE (Portafogli) ---
                handleMacroUpload(e) {
                    const f = e.target.files[0]; if(!f) return;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                            const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                            if(sheet.length<2) throw new Error("File vuoto");
                            
                            const h = sheet[0].map(x=>String(x).toLowerCase().trim());
                            const rows = sheet.slice(1);
                            
                            // Cerca colonne flessibili per Macro
                            const find = (k, def) => { const i = h.findIndex(x => k.some(w => x.includes(w))); return i > -1 ? i : def; };
                            
                            // Mappatura basata sulla tua immagine: Nome Progetto, # NDG, Tipo, Cedente
                            const iName = find(['nome','proge','project','ptf'], 0);
                            const iNdg = find(['ndg','pratic','num','#','cases'], 1);
                            const iTipo = find(['tipo','new','stat'], 2); // Cerca "Nuovo" qui
                            const iCed = find(['ced','bank','orig'], 4); // Default 4 o cerca ovunque

                            const newPtfs = rows.map(r => {
                                if(!r || r.length===0) return null;
                                const cases = parseInt(r[iNdg]) || 0;
                                if(cases <= 0) return null; // Salta righe vuote
                                
                                const tipoVal = String(r[iTipo] || '').toLowerCase();
                                const isNew = tipoVal.includes('nuov') || tipoVal.includes('new');

                                return {
                                    name: r[iName] || 'Ptf Importato',
                                    cedant: r[iCed] || 'Unknown',
                                    cases: cases,
                                    is_new: isNew
                                };
                            }).filter(p => p !== null);

                            this.manualPortfolios = newPtfs; // Sostituisce la lista
                            alert(`Importati ${newPtfs.length} portafogli con successo!`);
                        } catch(err) { alert("Errore Import Macro: "+err.message); }
                    };
                    r.readAsArrayBuffer(f);
                },

                // --- UPLOAD PER DETAIL MODE (Righe) ---
                handleDetailUpload(e) {
                    const f = e.target.files[0]; if(!f) return;
                    this.isProcessing = true;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                            const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                            if(sheet.length<2) throw new Error("File vuoto");
                            
                            const h = sheet[0].map(x=>String(x).toLowerCase().trim());
                            const rows = sheet.slice(1);
                            
                            const find = (k, def) => { const i = h.findIndex(x => k.some(w => x.includes(w))); return i > -1 ? i : def; };
                            const iId = find(['id','soff','ndg'], 0);
                            const iPtf = find(['por','ptf','nom'], 1);
                            const iSt = find(['buck','stat','fasc'], 2);
                            const iCed = find(['ced','ban','orig'], 3);

                            this.rawRows = rows.map(r => (!r || r.length===0) ? null : {
                                id: r[iId]||'N/A', ptf: r[iPtf]||'Unknown', status: r[iSt]||'Active', cedant: r[iCed]||'Unknown'
                            }).filter(r=>r && (r.id!=='N/A'||r.ptf!=='Unknown'));
                            
                            const s = {};
                            this.rawRows.forEach(r => {
                                const k = r.ptf+"||"+r.cedant;
                                if(!s[k]) s[k]={name:r.ptf, cedant:r.cedant, count:0};
                                s[k].count++;
                            });
                            this.portfolioStats = Object.values(s);
                            this.isProcessing=false;
                        } catch(err) { alert("Errore: "+err.message); this.isProcessing=false; }
                    };
                    r.readAsArrayBuffer(f);
                },

                async calculateAssignment() {
                    this.isProcessing = true;
                    this.resetResults();

                    const teamsP = this.teams.map(t => ({ leader: t.leader, lm_count: t.managers.length }));
                    let ptfP = this.mode === 'macro' 
                        ? this.manualPortfolios.map(p=>({ name: p.name, cedant: p.cedant, count: parseInt(p.cases), is_new: p.is_new }))
                        : this.portfolioStats;

                    const totalCases = ptfP.reduce((s,p)=>s+p.count,0);
                    const totalLMs = teamsP.reduce((s,t)=>s+t.lm_count,0);
                    const ideal = Math.round(totalCases/totalLMs);

                    const prompt = `
                        Agisci come algoritmo di logistica.
                        INPUT:
                        - Totale Pratiche: ${totalCases}
                        - Totale LM: ${totalLMs}
                        - Teams: ${JSON.stringify(teamsP)}
                        - Portafogli: ${JSON.stringify(ptfP)}

                        OBIETTIVO: Target ~${ideal} pratiche/LM.
                        REGOLE:
                        1. Assegna TUTTI i portafogli. 
                        2. Se un Team non riceve nulla, la soluzione √® ERRATA.
                        3. √à FONDAMENTALE assegnare tutti i portafogli della stessa Cedente allo stesso Team.
       - ECCEZIONE: Viola la regola 1 (spezza la cedente su pi√π team) SOLO SE √® l'unico modo per rispettare la regola 1 e la regola 2.

                        OUTPUT JSON ESCLUSIVAMENTE (senza testo prima o dopo):
                        {
                            "assignments": [{ "portfolio_name": "Nome", "team_leader": "NomeEsattoTeamLeader", "cases": 123, "is_new": true/false }],
                            "reasoning": "Spiegazione"
                        }
                    `;

                    try {
                        const u = `https://generativelanguage.googleapis.com/v1beta/${this.selectedModel||'gemini-1.5-flash'}:generateContent?key=${this.apiKey}`;
                        const res = await fetch(u, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]}) });
                        const d = await res.json();
                        if(d.error) throw new Error(d.error.message);

                        // --- FIX ROBUST JSON PARSING ---
                        let rawText = d.candidates[0].content.parts[0].text;
                        rawText = rawText.replace(/```json|```/g, '');
                        const start = rawText.indexOf('{');
                        const end = rawText.lastIndexOf('}');
                        
                        if(start === -1 || end === -1) throw new Error("Risposta AI non valida (no JSON)");
                        
                        const jsonStr = rawText.substring(start, end + 1);
                        const ai = JSON.parse(jsonStr);
                        
                        this.aiReasoning = ai.reasoning;

                        if(this.mode === 'macro') {
                            this.macroResults = ai.assignments;
                            this.applyRobinHoodLogic_Macro(totalCases, totalLMs);
                        } else {
                            this.applyDetailAssignment(ai.assignments);
                            this.applyRobinHoodLogic_Detail(ideal);
                        }

                        this.$nextTick(()=>this.renderChart());

                    } catch(e) { alert("Errore: "+e.message); } 
                    finally { this.isProcessing=false; }
                },

                applyDetailAssignment(assigns) {
                    const map = {}; assigns.forEach(a=>map[a.portfolio_name]=a.team_leader);
                    const tMap = {}; this.teams.forEach(t=>tMap[t.leader.toLowerCase().trim()]=t);

                    const grp = {};
                    this.rawRows.forEach(r => { if(!grp[r.ptf]) grp[r.ptf]=[]; grp[r.ptf].push(r); });

                    for(const [p, rows] of Object.entries(grp)) {
                        rows.sort((a,b)=>(String(a.status)||'').localeCompare(String(b.status)||''));
                        let leaderName = map[p] || '';
                        let targetT = tMap[leaderName.toLowerCase().trim()];
                        if(!targetT) targetT = this.teams[0]; 

                        let i = 0;
                        rows.forEach(r => {
                            this.assignedRows.push({ ...r, team: targetT.leader, assignedTo: targetT.managers[i % targetT.managers.length] });
                            i++;
                        });
                    }
                },

                applyRobinHoodLogic_Detail(idealTarget) {
                    const stats = {};
                    this.teams.forEach(t => stats[t.leader] = { count: 0, managers: t.managers.length, obj: t });
                    this.assignedRows.forEach(r => { if(stats[r.team]) stats[r.team].count++; });

                    let rebalanced = false;
                    let logs = [];

                    for(let loop=0; loop<5; loop++) {
                        let minT=null, maxT=null;
                        let minLoad=Infinity, maxLoad=-Infinity;

                        for(const k in stats) {
                            const load = stats[k].count / stats[k].managers;
                            if(load < minLoad) { minLoad = load; minT = k; }
                            if(load > maxLoad) { maxLoad = load; maxT = k; }
                        }

                        const diff = maxLoad - minLoad;
                        if(diff < (idealTarget * 0.2)) break;

                        const amountToMove = Math.round((diff * stats[minT].managers) / 2);
                        if(amountToMove <= 0) break;

                        rebalanced = true;
                        logs.push(`Giro ${loop+1}: Spostate ${amountToMove} pratiche da ${maxT} (${Math.round(maxLoad)}/LM) a ${minT} (${Math.round(minLoad)}/LM)`);

                        let moved = 0;
                        for(let i=0; i<this.assignedRows.length; i++) {
                            if(this.assignedRows[i].team === maxT) {
                                this.assignedRows[i].team = minT;
                                const tObj = stats[minT].obj;
                                this.assignedRows[i].assignedTo = tObj.managers[moved % tObj.managers.length];
                                
                                stats[maxT].count--;
                                stats[minT].count++;
                                moved++;
                                if(moved >= amountToMove) break;
                            }
                        }
                    }
                    if(rebalanced) this.rebalancingLog = "L'AI aveva lasciato sbilanciamenti.\n" + logs.join("\n");
                },

                applyRobinHoodLogic_Macro(total, lms) {
                   // No-op per visualizzazione
                },

                renderChart() {
                    const ctx = document.getElementById('resultChart').getContext('2d');
                    if (this.chartInstance) this.chartInstance.destroy();
                    const labels = this.teams.map(t => t.leader);
                    const dataV = [];

                    this.teams.forEach(t => {
                        let cnt = 0;
                        if(this.mode==='macro') {
                            cnt = this.macroResults.filter(r=>r.team_leader===t.leader).reduce((s,x)=>s+x.cases,0);
                        } else {
                            cnt = this.assignedRows.filter(r=>r.team===t.leader).length;
                        }
                        dataV.push(Math.round(cnt/t.managers.length));
                    });

                    this.chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: labels, datasets: [{ label: 'Pratiche / LM (Reali)', data: dataV, backgroundColor: '#6366f1' }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                },

                exportExcel() {
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(this.mode==='macro'?this.macroResults:this.assignedRows);
                    XLSX.utils.book_append_sheet(wb, ws, "Assegnazioni");
                    XLSX.writeFile(wb, "Aequo_Final.xlsx");
                }
            }
        }).mount('#app');
    });
</script>
</body>
</html>
