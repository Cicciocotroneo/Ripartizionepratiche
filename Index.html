<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aequo - Smart Allocator</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        [v-cloak] { display: none !important; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #6366f1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        
        .tab-btn { padding: 10px 20px; font-weight: bold; border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; }
        .tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .tab-btn:hover:not(.active) { color: #334155; border-bottom-color: #cbd5e1; }
    </style>
</head>
<body>

<div id="app" v-cloak class="container mx-auto p-4 max-w-7xl">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-balance-scale text-indigo-600"></i> Aequo <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">v3.0 Auto-Model</span>
            </h1>
        </div>
        
        <div class="flex flex-col md:flex-row gap-3 w-full md:w-auto items-center">
            
            <div v-if="hasApiKey && availableModels.length > 0" class="flex items-center gap-2 text-sm bg-gray-50 p-1 rounded border">
                <i class="fas fa-microchip text-gray-500 ml-2"></i>
                <select v-model="selectedModel" class="bg-transparent border-none outline-none text-gray-700 font-medium cursor-pointer pr-2">
                    <option v-for="m in availableModels" :value="m.name">{{ m.displayName }}</option>
                </select>
            </div>

            <div class="flex gap-2 w-full md:w-auto">
                <input v-if="!hasApiKey" type="password" v-model="tempApiKey" placeholder="Incolla API Key Gemini" class="border border-gray-300 p-2 rounded text-sm flex-grow w-64">
                <button @click="saveApiKey" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-700 transition whitespace-nowrap">
                    {{ hasApiKey ? 'Key Salvata' : 'Connetti' }}
                </button>
                <button v-if="hasApiKey" @click="resetApiKey" class="text-red-500 hover:text-red-700 px-2 text-sm" title="Rimuovi Key">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-5 space-y-6">
            
            <div class="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg px-4 pt-2">
                <button @click="mode = 'macro'" class="tab-btn" :class="{ 'active': mode === 'macro' }">
                    <i class="fas fa-cubes"></i> Macro (Portafogli)
                </button>
                <button @click="mode = 'detail'" class="tab-btn" :class="{ 'active': mode === 'detail' }">
                    <i class="fas fa-list"></i> Dettaglio (Excel)
                </button>
            </div>

            <div v-if="mode === 'macro'" class="card border-l-4 border-orange-500 animate-fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Inserimento Portafogli</h2>
                    <button @click="addManualPortfolio" class="text-orange-600 hover:text-orange-800 text-sm font-bold"><i class="fas fa-plus"></i> Aggiungi</button>
                </div>
                
                <div class="space-y-3 max-h-[300px] overflow-y-auto custom-scroll pr-2">
                    <div v-for="(ptf, idx) in manualPortfolios" :key="idx" class="bg-gray-50 p-3 rounded border relative">
                        <button @click="removeManualPortfolio(idx)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                        
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" v-model="ptf.name" placeholder="Nome Ptf" class="border p-1.5 rounded text-sm w-full">
                            <input type="text" v-model="ptf.cedant" placeholder="Cedente" class="border p-1.5 rounded text-sm w-full">
                        </div>
                        <div class="grid grid-cols-2 gap-2 items-center">
                            <input type="number" v-model="ptf.cases" placeholder="N. Pratiche" class="border p-1.5 rounded text-sm w-full">
                            <label class="flex items-center space-x-2 text-sm text-gray-600 cursor-pointer">
                                <input type="checkbox" v-model="ptf.is_new" class="form-checkbox text-orange-500 rounded">
                                <span>Nuovo?</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div v-if="manualPortfolios.length === 0" class="text-center text-gray-400 text-sm py-4">
                    Nessun portafoglio. Clicca su "Aggiungi".
                </div>
            </div>

            <div v-if="mode === 'detail'" class="card border-l-4 border-blue-500 animate-fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Import Dati Massivi</h2>
                    <span v-if="rawRows.length > 0" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">
                        {{ rawRows.length.toLocaleString() }} Righe
                    </span>
                </div>
                
                <div class="flex items-center gap-3">
                    <label class="cursor-pointer bg-blue-50 text-blue-700 hover:bg-blue-100 px-4 py-6 w-full border-2 border-dashed border-blue-200 rounded-lg text-center transition">
                        <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i><br>
                        <span class="text-sm font-medium">Carica Excel (20k+ righe)</span>
                        <input type="file" @change="handleFileUpload" class="hidden" accept=".xlsx, .csv">
                    </label>
                </div>
                <p class="text-xs text-gray-400 mt-2">Colonne necessarie: Portafoglio, Cedente, Id Pratica...</p>
            </div>

            <div class="card border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Team & Loan Managers</h2>
                    <button @click="addTeam" class="text-indigo-600 hover:text-indigo-800 text-sm font-bold"><i class="fas fa-plus"></i> Team</button>
                </div>

                <div class="space-y-4 max-h-[300px] overflow-y-auto custom-scroll pr-2">
                    <div v-for="(team, idx) in teams" :key="idx" class="bg-gray-50 p-3 rounded border border-gray-200 relative">
                        <button @click="removeTeam(idx)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        <div class="mb-2">
                            <input type="text" v-model="team.leader" class="w-full font-bold bg-white border border-gray-300 rounded p-1 text-sm" placeholder="Nome Team Leader">
                        </div>
                        <textarea v-model="team.managerInput" @blur="parseManagers(idx)" class="w-full bg-white border border-gray-300 rounded p-2 text-xs h-16 resize-none" placeholder="Nomi LM (es: Luca, Marco...)"></textarea>
                        <div class="text-right text-xs text-indigo-600 mt-1 font-bold">{{ team.managers.length }} Managers</div>
                    </div>
                </div>
            </div>

            <button @click="calculateAssignment" :disabled="isProcessing || !hasApiKey || (!canProceed) || !selectedModel" 
                class="w-full bg-gradient-to-r from-slate-700 to-slate-900 text-white py-4 rounded-lg text-xl font-bold shadow-lg hover:shadow-xl transition disabled:opacity-50 flex items-center justify-center gap-3">
                <span v-if="!isProcessing"><i class="fas fa-brain"></i> Calcola Assegnazione</span>
                <span v-else class="flex items-center gap-2">
                    <span class="loader border-white border-t-transparent"></span>
                    <span class="text-base font-normal">Analisi con {{ selectedModelShort }}...</span>
                </span>
            </button>

            <div v-if="!selectedModel && hasApiKey" class="text-center text-red-500 text-xs">
                Nessun modello disponibile trovato. Verifica la API Key.
            </div>

        </div>

        <div class="lg:col-span-7 space-y-6">
            
            <div v-if="hasResults" class="card">
                <h3 class="text-gray-700 font-bold mb-4">ðŸ“Š Bilanciamento Carico Stimato</h3>
                <div class="h-64">
                    <canvas id="resultChart"></canvas>
                </div>
                <p class="text-xs text-center text-gray-400 mt-2">
                    {{ mode === 'macro' ? 'Media pratiche per Manager (Calcolo matematico)' : 'Pratiche effettive assegnate per Manager (Conta reale)' }}
                </p>
            </div>

            <div v-if="hasResults" class="card border-t-4 border-green-500 bg-green-50">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-green-900">Risultato {{ mode === 'macro' ? 'Macro' : 'Dettaglio' }}</h2>
                    <button @click="exportExcel" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold shadow transition">
                        <i class="fas fa-download"></i> Excel
                    </button>
                </div>

                <div class="bg-white p-3 rounded border border-green-200 mb-4 text-sm text-gray-700">
                    <strong class="text-purple-600">Strategia AI ({{ selectedModelShort }}):</strong> {{ aiReasoning }}
                </div>

                <div v-if="mode === 'macro'" class="overflow-x-auto border rounded bg-white">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-600">
                            <tr>
                                <th class="p-3">Team Leader</th>
                                <th class="p-3">Portafoglio</th>
                                <th class="p-3">Cedente</th>
                                <th class="p-3 text-right">Pratiche</th>
                                <th class="p-3 text-center">Nuovo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(row, idx) in macroResults" :key="idx" class="border-b hover:bg-gray-50">
                                <td class="p-3 font-bold text-indigo-700">{{ row.team_leader }}</td>
                                <td class="p-3">{{ row.portfolio_name }}</td>
                                <td class="p-3 text-gray-500">{{ row.cedant }}</td>
                                <td class="p-3 text-right font-mono">{{ row.cases }}</td>
                                <td class="p-3 text-center">
                                    <span v-if="row.is_new" class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded font-bold">NEW</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div v-if="mode === 'detail'" class="overflow-x-auto border rounded bg-white max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-600 sticky top-0">
                            <tr>
                                <th class="p-3">ID</th>
                                <th class="p-3">Ptf</th>
                                <th class="p-3">Status</th>
                                <th class="p-3 bg-yellow-50">LM</th>
                                <th class="p-3 bg-blue-50">Team</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="row in assignedRows.slice(0, 50)" :key="row.id" class="border-b hover:bg-gray-50">
                                <td class="p-3 font-mono text-xs">{{ row.id }}</td>
                                <td class="p-3">{{ row.ptf }}</td>
                                <td class="p-3">{{ row.status }}</td>
                                <td class="p-3 font-bold bg-yellow-50">{{ row.assignedTo }}</td>
                                <td class="p-3 bg-blue-50">{{ row.team }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="p-2 text-center text-xs text-gray-400">Prime 50 righe mostrate.</div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    apiKey: localStorage.getItem('aequo_api_key') || '',
                    tempApiKey: '',
                    isProcessing: false,
                    mode: 'macro', 
                    
                    // Modelli
                    availableModels: [],
                    selectedModel: '', // Es. "models/gemini-1.5-flash"

                    // Teams
                    teams: [
                        { leader: 'Team Alpha', managerInput: 'Mario, Luigi', managers: ['Mario', 'Luigi'] },
                        { leader: 'Team Beta', managerInput: 'Anna, Sofia, Marco', managers: ['Anna', 'Sofia', 'Marco'] }
                    ],
                    
                    // Dati
                    manualPortfolios: [
                        { name: 'Ptf 2024-A', cedant: 'Bank X', cases: 1500, is_new: true },
                        { name: 'Ptf Legacy', cedant: 'Bank Y', cases: 800, is_new: false }
                    ],
                    macroResults: [],
                    rawRows: [],
                    portfolioStats: [],
                    assignedRows: [],
                    aiReasoning: '',
                    chartInstance: null
                }
            },
            computed: {
                hasApiKey() { return this.apiKey && this.apiKey.length > 5; },
                canProceed() {
                    if (this.mode === 'macro') return this.manualPortfolios.length > 0;
                    return this.rawRows.length > 0;
                },
                hasResults() {
                    return (this.mode === 'macro' && this.macroResults.length > 0) || 
                           (this.mode === 'detail' && this.assignedRows.length > 0);
                },
                selectedModelShort() {
                    if (!this.selectedModel) return '';
                    return this.selectedModel.split('/').pop().replace('gemini-', '').replace('-latest', '');
                }
            },
            watch: {
                mode() {
                    this.macroResults = [];
                    this.assignedRows = [];
                    this.aiReasoning = '';
                    if(this.chartInstance) { this.chartInstance.destroy(); this.chartInstance = null; }
                }
            },
            mounted() {
                // Se c'Ã¨ giÃ  una key salvata, cerca i modelli all'avvio
                if (this.hasApiKey) {
                    this.fetchModels();
                }
            },
            methods: {
                async saveApiKey() {
                    if (this.tempApiKey) {
                        localStorage.setItem('aequo_api_key', this.tempApiKey);
                        this.apiKey = this.tempApiKey;
                        this.tempApiKey = '';
                        await this.fetchModels();
                    }
                },
                resetApiKey() { 
                    localStorage.removeItem('aequo_api_key'); 
                    this.apiKey = ''; 
                    this.availableModels = [];
                    this.selectedModel = '';
                },

                // ----------------------------------------
                // NUOVA FUNZIONE: RECUPERO AUTOMATICO MODELLI
                // ----------------------------------------
                async fetchModels() {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${this.apiKey}`);
                        if (!response.ok) throw new Error("Key non valida o errore connessione");
                        
                        const data = await response.json();
                        
                        // Filtra solo i modelli Gemini che generano contenuto
                        const geminiModels = data.models.filter(m => 
                            m.name.includes('gemini') && 
                            m.supportedGenerationMethods.includes('generateContent')
                        );

                        // Formatta per la select
                        this.availableModels = geminiModels.map(m => ({
                            name: m.name,
                            displayName: m.displayName || m.name.split('/').pop()
                        }));

                        // LOGICA DI SELEZIONE AUTOMATICA INTELLIGENTE
                        // 1. Cerca "flash" (veloce/economico)
                        let bestMatch = this.availableModels.find(m => m.name.includes('1.5-flash'));
                        // 2. Se non c'Ã¨, cerca "pro"
                        if (!bestMatch) bestMatch = this.availableModels.find(m => m.name.includes('1.5-pro'));
                        // 3. Altrimenti il primo della lista
                        if (!bestMatch && this.availableModels.length > 0) bestMatch = this.availableModels[0];

                        if (bestMatch) {
                            this.selectedModel = bestMatch.name;
                        }

                    } catch (e) {
                        alert("Impossibile recuperare i modelli: " + e.message);
                        this.resetApiKey();
                    }
                },
                
                // Teams
                addTeam() { this.teams.push({ leader: '', managerInput: '', managers: ['LM 1'] }); },
                removeTeam(idx) { this.teams.splice(idx, 1); },
                parseManagers(idx) {
                    const raw = this.teams[idx].managerInput;
                    if (!raw || !raw.trim()) { this.teams[idx].managers = ['LM 1']; return; }
                    this.teams[idx].managers = raw.split(/,|\n/).map(n => n.trim()).filter(n => n.length > 0);
                },

                // Macro Data
                addManualPortfolio() { this.manualPortfolios.push({ name: '', cedant: '', cases: 0, is_new: false }); },
                removeManualPortfolio(idx) { this.manualPortfolios.splice(idx, 1); },

                // Detail Data
                handleFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    this.isProcessing = true;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            this.rawRows = data.map(r => ({
                                ptf: r['Portafoglio'] || r['Portfolio'] || 'Unknown',
                                cedant: r['Cedente'] || r['Originator'] || 'Unknown',
                                id: r['Id Pratica'] || r['Id'] || 'N/A',
                                status: r['Status'] || r['Stato'] || 'Active'
                            }));
                            
                            const stats = {};
                            this.rawRows.forEach(r => {
                                const key = r.ptf + "||" + r.cedant;
                                if (!stats[key]) stats[key] = { name: r.ptf, cedant: r.cedant, count: 0 };
                                stats[key].count++;
                            });
                            this.portfolioStats = Object.values(stats);
                            this.isProcessing = false;
                        } catch(e) { alert("Err Excel: "+e); this.isProcessing = false; }
                    };
                    reader.readAsArrayBuffer(file);
                },

                async calculateAssignment() {
                    this.isProcessing = true;
                    this.macroResults = [];
                    this.assignedRows = [];
                    
                    const teamsPayload = this.teams.map(t => ({ leader: t.leader, lm_count: t.managers.length }));
                    
                    let portfoliosPayload = [];
                    if (this.mode === 'macro') {
                        portfoliosPayload = this.manualPortfolios.map(p => ({
                            name: p.name, cedant: p.cedant, count: parseInt(p.cases), is_new: p.is_new
                        }));
                    } else {
                        portfoliosPayload = this.portfolioStats;
                    }

                    const prompt = `
                        Agisci come algoritmo di allocazione NPL.
                        MODE: ${this.mode === 'macro' ? 'MACRO' : 'DETAIL'}.
                        TEAMS: ${JSON.stringify(teamsPayload)}
                        PORTFOLIOS: ${JSON.stringify(portfoliosPayload)}

                        OBIETTIVO:
                        1. Assegna ogni portafoglio a un Team Leader.
                        2. Raggruppa per Cedente.
                        3. EquitÃ : (Totale Pratiche / Numero LM del team) deve essere simile.
                        4. ${this.mode === 'macro' ? 'Se is_new=true, distribuisci tra team diversi.' : ''}

                        OUTPUT JSON:
                        {
                            "assignments": [
                                { "portfolio_name": "Nome", "cedant": "Nome", "team_leader": "Nome Leader Assegnato", "cases": 123, "is_new": true/false }
                            ],
                            "reasoning": "Spiegazione breve"
                        }
                    `;

                    try {
                        // USA IL MODELLO SELEZIONATO DINAMICAMENTE
                        const url = `https://generativelanguage.googleapis.com/v1beta/${this.selectedModel}:generateContent?key=${this.apiKey}`;
                        
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        
                        const aiRes = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                        this.aiReasoning = aiRes.reasoning;

                        if (this.mode === 'macro') {
                            this.macroResults = aiRes.assignments;
                        } else {
                            this.applyDetailAssignment(aiRes.assignments);
                        }
                        
                        this.$nextTick(() => this.renderChart());
                        
                    } catch (e) {
                        alert("Errore AI: " + e.message);
                    } finally {
                        this.isProcessing = false;
                    }
                },

                applyDetailAssignment(aiAssignments) {
                    const ptfMap = {}; 
                    aiAssignments.forEach(a => ptfMap[a.portfolio_name] = a.team_leader);
                    
                    const teamObjMap = {};
                    this.teams.forEach(t => teamObjMap[t.leader] = t);

                    const grouped = {};
                    this.rawRows.forEach(r => {
                        if (!grouped[r.ptf]) grouped[r.ptf] = [];
                        grouped[r.ptf].push(r);
                    });

                    for (const [ptf, rows] of Object.entries(grouped)) {
                        rows.sort((a,b) => (a.status||'').localeCompare(b.status||'')); 
                        const leader = ptfMap[ptf];
                        const team = teamObjMap[leader] || this.teams[0];
                        
                        let lmIdx = 0;
                        rows.forEach(r => {
                            this.assignedRows.push({
                                ...r,
                                team: team.leader,
                                assignedTo: team.managers[lmIdx % team.managers.length]
                            });
                            lmIdx++;
                        });
                    }
                },

                renderChart() {
                    const ctx = document.getElementById('resultChart').getContext('2d');
                    if (this.chartInstance) this.chartInstance.destroy();

                    const labels = this.teams.map(t => t.leader);
                    const dataValues = [];

                    if (this.mode === 'macro') {
                        this.teams.forEach(t => {
                            const totalCases = this.macroResults
                                .filter(r => r.team_leader === t.leader)
                                .reduce((sum, r) => sum + r.cases, 0);
                            dataValues.push(Math.round(totalCases / t.managers.length));
                        });
                    } else {
                        this.teams.forEach(t => {
                            const teamRows = this.assignedRows.filter(r => r.team === t.leader);
                            dataValues.push(Math.round(teamRows.length / t.managers.length));
                        });
                    }

                    this.chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Media Pratiche per Loan Manager',
                                data: dataValues,
                                backgroundColor: '#4f46e5',
                                borderRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                },

                exportExcel() {
                    const wb = XLSX.utils.book_new();
                    if (this.mode === 'macro') {
                        const ws = XLSX.utils.json_to_sheet(this.macroResults);
                        XLSX.utils.book_append_sheet(wb, ws, "Macro_Assignment");
                    } else {
                        const ws = XLSX.utils.json_to_sheet(this.assignedRows);
                        XLSX.utils.book_append_sheet(wb, ws, "Detail_Assignment");
                    }
                    XLSX.writeFile(wb, `Aequo_Result_${this.mode}.xlsx`);
                }
            }
        }).mount('#app');
    });
</script>
</body>
</html>
