<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADR - Assegnazione Dinamica Risorse v10.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ADR Manager">
    <meta name="theme-color" content="#4f46e5">
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1063/1063376.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1063/1063376.png">

    <style>
        [v-cloak] { display: none !important; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8fafc; overscroll-behavior-y: none; } /* Prevents pull-to-refresh on mobile */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .loader { border: 3px solid #e2e8f0; border-top: 3px solid #6366f1; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        
        .tab-btn { padding: 12px 15px; font-weight: bold; border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; background-color: #f8fafc; }
        
        /* Modal Styles */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 9999; 
            display: flex; justify-content: center; align-items: flex-end md:align-items-center; 
            backdrop-filter: blur(3px);
        }
        .modal-content { 
            background: white; border-radius: 16px 16px 0 0 md:border-radius-16px; width: 100%; md:width: 95%; max-width: 1000px; 
            max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;
            box-shadow: 0 -10px 25px rgba(0,0,0,0.1);
        }
        @media (min-width: 768px) {
            .modal-content { border-radius: 12px; height: auto; }
            .modal-overlay { align-items: center; }
        }
    </style>
</head>
<body>

<div id="app" v-cloak class="container mx-auto p-4 max-w-7xl pb-20"> <div v-if="showConfigModal" class="modal-overlay">
        <div class="modal-content animate-fade-in">
            <div class="bg-indigo-600 p-4 text-white flex justify-between items-center sticky top-0 z-10 shrink-0">
                <h2 class="text-lg font-bold"><i class="fas fa-users-cog"></i> Configurazione Team</h2>
                <button @click="showConfigModal = false" class="text-white p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-4 overflow-y-auto">
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-4 text-xs text-yellow-800">
                    Definisci i Team Leader e i Loan Manager prima del calcolo.
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="(team, idx) in teams" :key="idx" class="bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm relative">
                        <button @click="removeTeam(idx)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>
                        <div class="mb-2">
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Team Leader</label>
                            <input type="text" v-model="team.leader" class="w-full font-bold bg-white border border-gray-300 rounded p-2 text-sm focus:border-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Membri</label>
                            <textarea v-model="team.managerInput" @blur="parseManagers(idx)" class="w-full bg-white border border-gray-300 rounded p-2 text-xs h-20 resize-none focus:border-indigo-500 outline-none" placeholder="Es: Mario, Luca..."></textarea>
                        </div>
                    </div>
                    <div @click="addTeam" class="border-2 border-dashed border-gray-300 rounded-lg flex flex-col justify-center items-center cursor-pointer hover:bg-gray-50 h-40 text-gray-400 hover:text-indigo-500">
                        <i class="fas fa-plus-circle text-3xl mb-1"></i><span class="font-bold text-sm">Aggiungi</span>
                    </div>
                </div>
            </div>
            <div class="bg-gray-100 p-4 border-t flex justify-end gap-3 sticky bottom-0 shrink-0">
                <button @click="showConfigModal = false" class="px-4 py-2 text-gray-600 font-bold text-sm bg-white border rounded">Annulla</button>
                <button @click="showConfigModal = false" class="px-4 py-2 bg-indigo-600 text-white rounded font-bold text-sm shadow">Conferma</button>
            </div>
        </div>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
        <div>
            <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-balance-scale text-indigo-600"></i> ADR - Assegnazione Dinamica Risorse <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded">v10.1</span>
            </h1>
            
        </div>
        <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto items-center">
            <div v-if="hasApiKey && availableModels.length > 0" class="w-full md:w-auto">
                <select v-model="selectedModel" class="w-full bg-gray-50 border text-gray-700 text-xs rounded p-2 outline-none">
                    <option v-for="m in availableModels" :value="m.name">{{ m.displayName }}</option>
                </select>
            </div>
            <div class="flex gap-2 w-full md:w-auto">
                <input v-if="!hasApiKey" type="password" v-model="tempApiKey" placeholder="API Key" class="border border-gray-300 p-2 rounded text-xs flex-grow">
                <button @click="saveApiKey" class="bg-slate-800 text-white px-3 py-2 rounded text-xs font-bold whitespace-nowrap">{{ hasApiKey ? 'OK' : 'Salva' }}</button>
                <button v-if="hasApiKey" @click="resetApiKey" class="text-red-500 hover:text-red-700 px-2"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-5 space-y-6">
            <div class="flex border-b border-gray-200 mb-4 bg-white rounded-t-lg px-2 pt-2 overflow-x-auto no-scrollbar">
                <button @click="mode = 'macro'" class="tab-btn" :class="{ 'active': mode === 'macro' }"><i class="fas fa-cubes"></i> Macro</button>
                <button @click="mode = 'detail'" class="tab-btn" :class="{ 'active': mode === 'detail' }"><i class="fas fa-list"></i> Dettaglio</button>
                <button @click="mode = 'rebalance'" class="tab-btn" :class="{ 'active': mode === 'rebalance' }"><i class="fas fa-sync-alt"></i> Ribilancia</button>
            </div>

            <div v-if="mode === 'macro'" class="card border-l-4 border-orange-500 animate-fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Portafogli</h2>
                    <div class="flex gap-2">
                        <label class="cursor-pointer bg-green-50 text-green-700 px-3 py-1 rounded text-xs font-bold border border-green-200 flex items-center gap-1">
                            <i class="fas fa-file-excel"></i> Importa
                            <input type="file" @change="handleMacroUpload" class="hidden" accept=".xlsx, .csv">
                        </label>
                        <button @click="addManualPortfolio" class="text-orange-600 font-bold text-xs bg-orange-50 px-3 py-1 rounded border border-orange-200"><i class="fas fa-plus"></i> Manuale</button>
                    </div>
                </div>
                <div class="space-y-3 max-h-[300px] overflow-y-auto custom-scroll pr-2">
                    <div v-for="(ptf, idx) in manualPortfolios" :key="idx" class="bg-gray-50 p-3 rounded border relative">
                        <button @click="removeManualPortfolio(idx)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="text" v-model="ptf.name" placeholder="Nome" class="border p-1 rounded text-xs w-full font-bold">
                            <input type="text" v-model="ptf.cedant" placeholder="Cedente" class="border p-1 rounded text-xs w-full">
                        </div>
                        <div class="grid grid-cols-2 gap-2 items-center">
                            <input type="number" v-model="ptf.cases" placeholder="# Pratiche" class="border p-1 rounded text-xs w-full">
                            <label class="flex items-center space-x-1 text-xs text-gray-600"><input type="checkbox" v-model="ptf.is_new" class="form-checkbox text-orange-500 rounded"><span>Nuovo</span></label>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="mode === 'detail'" class="card border-l-4 border-blue-500 animate-fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Import Dettaglio</h2>
                    <span v-if="rawRows.length > 0" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">{{ rawRows.length.toLocaleString() }} Righe</span>
                </div>
                <label class="cursor-pointer bg-blue-50 text-blue-700 hover:bg-blue-100 px-4 py-6 w-full border-2 border-dashed border-blue-200 rounded-lg text-center transition flex flex-col items-center">
                    <i class="fas fa-cloud-upload-alt text-2xl mb-2"></i>
                    <span class="text-sm font-medium">Tocca per caricare Excel</span>
                    <input type="file" @change="handleDetailUpload" class="hidden" accept=".xlsx, .csv">
                </label>
                <div class="mt-3 p-2 bg-gray-50 border border-gray-200 rounded text-[10px] text-gray-500">
                    Colonne: ID, Portafoglio, Status, Cedente, Tipo
                </div>
            </div>

            <div v-if="mode === 'rebalance'" class="card border-l-4 border-pink-500 animate-fade-in">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Ribilanciamento</h2>
                    <span v-if="rawRows.length > 0" class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-bold">{{ rawRows.length.toLocaleString() }} Righe</span>
                </div>
                <label class="cursor-pointer bg-pink-50 text-pink-700 hover:bg-pink-100 px-4 py-6 w-full border-2 border-dashed border-pink-200 rounded-lg text-center transition flex flex-col items-center">
                    <i class="fas fa-sync-alt text-2xl mb-2"></i>
                    <span class="text-sm font-medium">Tocca per caricare Excel</span>
                    <input type="file" @change="handleRebalanceUpload" class="hidden" accept=".xlsx, .csv">
                </label>
                <div class="mt-3 p-3 bg-pink-50 border border-pink-100 rounded text-[10px] text-pink-800">
                    Logica: Righe con Team vuoto = "Nuove".
                </div>
            </div>

            <div class="card border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-700">Organigramma</h2>
                    <button @click="showConfigModal = true" class="bg-yellow-100 text-yellow-800 font-bold py-1 px-3 rounded border border-yellow-300 text-xs flex items-center gap-1">
                        <i class="fas fa-edit"></i> Modifica
                    </button>
                </div>
                <div class="space-y-2 max-h-[200px] overflow-y-auto custom-scroll pr-2">
                    <div v-for="(team, idx) in teams" :key="idx" class="bg-gray-50 p-2 rounded border border-gray-200 flex justify-between items-center">
                        <div>
                            <div class="font-bold text-gray-800 text-sm">{{ team.leader }}</div>
                            <div class="text-[10px] text-gray-500 truncate w-32">{{ team.managers.length }} Members</div>
                        </div>
                        <div class="text-xs font-bold text-indigo-600">{{ team.managers.length }} LM</div>
                    </div>
                </div>
            </div>

            <button @click="calculateAssignment" :disabled="isProcessing || !hasApiKey || (!canProceed) || !selectedModel" 
                class="w-full bg-gradient-to-r from-slate-800 to-black text-white py-4 rounded-xl text-xl font-bold shadow-lg hover:shadow-xl transition disabled:opacity-50 flex items-center justify-center gap-3 active:scale-95 transform">
                <span v-if="!isProcessing"><i class="fas" :class="mode === 'rebalance' ? 'fa-sync-alt' : 'fa-brain'"></i> {{ mode === 'rebalance' ? 'Ribilancia' : 'Calcola' }}</span>
                <span v-else class="flex items-center gap-2"><span class="loader border-white border-t-transparent w-5 h-5"></span></span>
            </button>
        </div>

        <div class="lg:col-span-7 space-y-6">
            
            <div v-if="hasResults" class="card p-4">
                <h3 class="text-gray-700 font-bold mb-4 text-sm">üìä Bilanciamento Finale</h3>
                <div class="h-56"><canvas id="resultChart"></canvas></div>
            </div>

            <div v-if="hasResults" class="card border-t-4 border-green-500 bg-green-50 animate-fade-in p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-green-900">Risultato</h2>
                    <button @click="exportExcel" class="bg-green-600 text-white px-3 py-1.5 rounded text-xs font-bold shadow"><i class="fas fa-download"></i> Excel</button>
                </div>
                
                <div v-if="rebalancingLog" class="bg-yellow-50 border border-yellow-200 p-2 rounded mb-3 text-[10px] text-yellow-800 whitespace-pre-line">
                    <strong>‚ö†Ô∏è Auto-Correzione:</strong> {{ rebalancingLog }}
                </div>

                <div class="bg-white p-3 rounded border border-green-200 mb-3 text-xs text-gray-700 whitespace-pre-line max-h-32 overflow-y-auto">
                    <strong class="text-purple-600">AI:</strong> {{ aiReasoning }}
                </div>

                <div class="overflow-x-auto border rounded bg-white max-h-80">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-gray-100 text-gray-600 sticky top-0">
                            <tr v-if="mode === 'macro'">
                                <th class="p-2">Team</th><th class="p-2">Ptf</th><th class="p-2 text-right">N.</th><th class="p-2 text-center">Stato</th>
                            </tr>
                            <tr v-else>
                                <th class="p-2">ID</th><th class="p-2">Ptf</th><th class="p-2">LM</th><th class="p-2">Team</th><th class="p-2 text-center">Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-if="mode === 'macro'" v-for="(row, idx) in macroResults" :key="idx" class="border-b hover:bg-gray-50">
                                <td class="p-2 font-bold text-indigo-700">{{ row.team_leader }}</td><td class="p-2">{{ row.portfolio_name }}</td><td class="p-2 text-right font-mono">{{ row.cases }}</td>
                                <td class="p-2 text-center"><span v-if="row.is_new" class="bg-orange-100 text-orange-800 px-1 rounded font-bold">NEW</span></td>
                            </tr>
                            <tr v-else v-for="row in assignedRows.slice(0, 100)" :key="row.id" class="border-b hover:bg-gray-50">
                                <td class="p-2 font-mono">{{ row.id }}</td><td class="p-2 truncate max-w-[100px]">{{ row.ptf }}</td><td class="p-2 font-bold">{{ row.assignedTo }}</td><td class="p-2">{{ row.team }}</td>
                                <td class="p-2 text-center"><span v-if="row.moved" class="bg-purple-100 text-purple-700 px-1 rounded">Spostato</span><span v-else-if="row.was_new||row.is_new" class="bg-green-100 text-green-700 px-1 rounded">Nuovo</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="hasResults" class="card border-l-4 border-indigo-500 bg-indigo-50 animate-fade-in mt-4 p-4">
                <h3 class="text-sm font-bold text-indigo-900 mb-2"><i class="fas fa-magic"></i> Modifica con AI</h3>
                <div class="flex gap-2">
                    <input type="text" v-model="refinementPrompt" @keyup.enter="refineAssignment" 
                        class="w-full p-2 rounded border border-indigo-300 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" 
                        placeholder='Es: "Sposta Ptf Alpha a John"'>
                    <button @click="refineAssignment" :disabled="isRefining" class="bg-indigo-600 text-white px-4 rounded font-bold hover:bg-indigo-700 transition flex items-center">
                        <span v-if="!isRefining" class="text-xs">Applica</span>
                        <span v-else class="loader border-white border-t-transparent w-3 h-3"></span>
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    apiKey: localStorage.getItem('aequo_api_key') || '',
                    tempApiKey: '',
                    isProcessing: false,
                    isRefining: false,
                    refinementPrompt: '',
                    showConfigModal: false,
                    mode: 'macro', 
                    availableModels: [],
                    selectedModel: '',
                    
                    teams: [
                        { leader: 'John Lennon', managerInput: 'LM1, LM2, LM3, LM4, LM5', managers: ['LM1', 'LM2', 'LM3', 'LM4', 'LM5'] },
                        { leader: 'Paul McCartney', managerInput: 'LM6, LM7, LM8, LM9, LM10', managers: ['LM6', 'LM7', 'LM8', 'LM9', 'LM10'] },
                        { leader: 'George Harrison', managerInput: 'LM11, LM12, LM13, LM14, LM15', managers: ['LM11', 'LM12', 'LM13', 'LM14', 'LM15'] },
                        { leader: 'Ringo Starr', managerInput: 'LM16, LM17, LM18, LM19, LM20', managers: ['LM16', 'LM17', 'LM18', 'LM19', 'LM20'] }
                    ],
                    
                    manualPortfolios: [],
                    rawRows: [],
                    portfolioStats: [],
                    assignedRows: [],
                    macroResults: [],
                    aiReasoning: '',
                    rebalancingLog: '',
                    chartInstance: null
                }
            },
            computed: {
                hasApiKey() { return this.apiKey && this.apiKey.length > 5; },
                canProceed() { return (this.mode === 'macro' && this.manualPortfolios.length > 0) || (this.mode !== 'macro' && this.rawRows.length > 0); },
                hasResults() { return (this.mode === 'macro' && this.macroResults.length > 0) || (this.mode !== 'macro' && this.assignedRows.length > 0); },
                selectedModelShort() { return this.selectedModel ? this.selectedModel.split('/').pop().replace('gemini-', '').replace('-latest', '') : ''; }
            },
            watch: {
                mode() { this.resetResults(); }
            },
            mounted() { 
                if(this.hasApiKey) this.fetchModels(); 
                this.generateManifest(); // GENERA IL MANIFESTO DINAMICAMENTE
            },
            methods: {
                // --- FUNZIONE CRUCIALE PER STANDALONE ---
                generateManifest() {
                    const manifest = {
                        "name": "ADR Manager",
                        "short_name": "ADR",
                        "start_url": ".",
                        "display": "standalone",
                        "background_color": "#f8fafc",
                        "theme_color": "#4f46e5",
                        "orientation": "portrait",
                        "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/1063/1063376.png", "sizes": "512x512", "type": "image/png" }]
                    };
                    const stringManifest = JSON.stringify(manifest);
                    const blob = new Blob([stringManifest], {type: 'application/manifest+json'});
                    const manifestURL = URL.createObjectURL(blob);
                    
                    const link = document.createElement('link');
                    link.rel = 'manifest';
                    link.href = manifestURL;
                    document.head.appendChild(link);
                },

                resetResults() { this.macroResults=[]; this.assignedRows=[]; this.aiReasoning=''; this.rebalancingLog=''; if(this.chartInstance) { this.chartInstance.destroy(); this.chartInstance = null; } this.rawRows = []; },
                async saveApiKey() { if(this.tempApiKey) { localStorage.setItem('aequo_api_key', this.tempApiKey); this.apiKey = this.tempApiKey; this.tempApiKey = ''; await this.fetchModels(); } },
                resetApiKey() { localStorage.removeItem('aequo_api_key'); this.apiKey = ''; this.availableModels = []; this.selectedModel = ''; },
                
                async fetchModels() {
                    try {
                        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${this.apiKey}`);
                        const d = await r.json();
                        const gemini = d.models.filter(m => m.name.includes('gemini') && m.supportedGenerationMethods.includes('generateContent'));
                        this.availableModels = gemini.map(m => ({ name: m.name, displayName: m.displayName || m.name.split('/').pop() }));
                        let best = this.availableModels.find(m => m.name.includes('flash-latest')) || this.availableModels.find(m => m.name.includes('flash')) || this.availableModels[0];
                        if(best) this.selectedModel = best.name;
                    } catch(e) { alert("Errore Key: "+e.message); this.resetApiKey(); }
                },

                addTeam() { this.teams.push({ leader: '', managerInput: '', managers: ['LM1'] }); },
                removeTeam(i) { this.teams.splice(i,1); },
                parseManagers(i) {
                    const raw = this.teams[i].managerInput;
                    this.teams[i].managers = (raw && raw.trim()) ? raw.split(/,|\n/).map(n=>n.trim()).filter(n=>n.length>0) : [];
                },
                confirmConfig() { this.showConfigModal = false; },

                addManualPortfolio() { this.manualPortfolios.push({ name: '', cedant: '', cases: 0, is_new: false }); },
                removeManualPortfolio(i) { this.manualPortfolios.splice(i,1); },

                processExcel(e, callback) {
                    const f = e.target.files[0]; if(!f) return;
                    this.isProcessing = true;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        try {
                            const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                            const sheet = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                            if(sheet.length<2) throw new Error("File vuoto");
                            const h = sheet[0].map(x=>String(x).toLowerCase().trim());
                            const rows = sheet.slice(1);
                            callback(h, rows);
                            this.isProcessing = false;
                        } catch(err) { alert("Errore: "+err.message); this.isProcessing=false; }
                    };
                    r.readAsArrayBuffer(f);
                },

                handleMacroUpload(e) {
                    this.processExcel(e, (headers, rows) => {
                        const find = (k, def) => { const i = headers.findIndex(x => k.some(w => x.includes(w))); return i > -1 ? i : def; };
                        const iName = find(['nome','proge','project','ptf'], 0);
                        const iNdg = find(['ndg','pratic','num','#','cases'], 1);
                        const iTipo = find(['tipo','new','stat'], 2);
                        const iCed = find(['ced','bank','orig'], 3);
                        const newPtfs = rows.map(r => {
                            const cases = parseInt(r[iNdg]) || 0;
                            if(cases <= 0) return null;
                            const tipoVal = String(r[iTipo] || '').toLowerCase();
                            return { name: r[iName]||'Ptf', cedant: r[iCed]||'Unknown', cases: cases, is_new: tipoVal.includes('nuov')||tipoVal.includes('new') };
                        }).filter(p => p !== null);
                        this.manualPortfolios = newPtfs;
                        alert(`Importati ${newPtfs.length} portafogli.`);
                    });
                },

                handleDetailUpload(e) {
                    this.processExcel(e, (headers, rows) => {
                        const find = (k, def) => { const i = headers.findIndex(x => k.some(w => x.includes(w))); return i > -1 ? i : def; };
                        const iId = find(['id','soff','ndg'], 0);
                        const iPtf = find(['por','ptf','nom'], 1);
                        const iSt = find(['buck','stat','fasc'], 2);
                        const iCed = find(['ced','ban','orig'], 3);
                        const iTipo = find(['tipo','info','new'], 4); 
                        this.rawRows = rows.map(r => (!r || r.length===0) ? null : {
                            id: r[iId]||'N/A', ptf: r[iPtf]||'Unknown', status: r[iSt]||'Active', cedant: r[iCed]||'Unknown',
                            is_new: r[iTipo] ? (String(r[iTipo]).toLowerCase().includes('nuov') || String(r[iTipo]).toLowerCase().includes('new')) : false
                        }).filter(r=>r && (r.id!=='N/A'||r.ptf!=='Unknown'));
                        const s = {};
                        this.rawRows.forEach(r => {
                            const k = r.ptf+"||"+r.cedant;
                            if(!s[k]) s[k]={name:r.ptf, cedant:r.cedant, count:0, is_new: r.is_new};
                            s[k].count++;
                            if(r.is_new) s[k].is_new = true;
                        });
                        this.portfolioStats = Object.values(s);
                    });
                },

                handleRebalanceUpload(e) {
                    this.processExcel(e, (headers, rows) => {
                        const find = (k, def) => { const i = headers.findIndex(x => k.some(w => x.includes(w))); return i > -1 ? i : def; };
                        const iId = find(['id','soff','ndg'], 0);
                        const iPtf = find(['por','ptf','nom'], 1);
                        const iSt = find(['buck','stat','fasc'], 2);
                        const iCed = find(['ced','ban','orig'], 3);
                        const iTeam = find(['team','squadra','gruppo','resp'], 4); 
                        const iAssegn = find(['assegn','lm','gestore','owner'], 5);
                        const extractedTeams = {}; 
                        this.rawRows = rows.map(r => {
                            if (!r || r.length===0) return null;
                            const teamVal = r[iTeam] ? String(r[iTeam]).trim() : null;
                            const assignVal = r[iAssegn] ? String(r[iAssegn]).trim() : null;
                            if (teamVal) {
                                if(!extractedTeams[teamVal]) extractedTeams[teamVal] = new Set();
                                if(assignVal) extractedTeams[teamVal].add(assignVal);
                            }
                            const isAssigned = (teamVal && teamVal !== '') && (assignVal && assignVal !== '');
                            return {
                                id: r[iId]||'N/A', ptf: r[iPtf]||'Unknown', status: r[iSt]||'Active', cedant: r[iCed]||'Unknown',
                                currentTeam: isAssigned ? teamVal : null, currentLM: isAssigned ? assignVal : null, was_new: !isAssigned
                            };
                        }).filter(r=>r && (r.id!=='N/A'||r.ptf!=='Unknown'));
                        if (Object.keys(extractedTeams).length > 0) {
                            this.teams = Object.keys(extractedTeams).map(leader => {
                                const mngs = Array.from(extractedTeams[leader]);
                                return { leader: leader, managers: mngs, managerInput: mngs.join(', ') };
                            });
                            this.showConfigModal = true;
                        }
                        const s = {};
                        this.rawRows.forEach(r => {
                            const k = r.ptf+"||"+r.cedant;
                            if(!s[k]) s[k] = { name: r.ptf, cedant: r.cedant, count: 0, current_team: r.currentTeam || null, is_new: !r.currentTeam };
                            s[k].count++;
                            if(r.currentTeam && !s[k].current_team) { s[k].current_team = r.currentTeam; s[k].is_new = false; }
                        });
                        this.portfolioStats = Object.values(s);
                    });
                },

                async calculateAssignment() {
                    this.isProcessing = true;
                    this.resetResultsOnly();
                    await this.runAiAllocation(null); 
                    this.isProcessing = false;
                },

                async refineAssignment() {
                    if(!this.refinementPrompt.trim()) return;
                    this.isRefining = true;
                    await this.runAiAllocation(this.refinementPrompt);
                    this.refinementPrompt = ''; 
                    this.isRefining = false;
                },

                async runAiAllocation(userRefinementInstruction) {
                    const teamsP = this.teams.map(t => ({ leader: t.leader, lm_count: t.managers.length }));
                    let ptfP = [];
                    if (userRefinementInstruction && this.mode === 'macro') {
                        ptfP = this.macroResults.map(r => ({ name: r.portfolio_name, cedant: r.cedant, count: r.cases, is_new: r.is_new, current_team: r.team_leader }));
                    } else if (userRefinementInstruction && this.mode !== 'macro') {
                        const tempStats = {};
                        this.assignedRows.forEach(r => {
                            const k = r.ptf+"||"+r.cedant;
                            if(!tempStats[k]) tempStats[k] = { name: r.ptf, cedant: r.cedant, count: 0, current_team: r.team, is_new: r.was_new || r.is_new };
                            tempStats[k].count++;
                        });
                        ptfP = Object.values(tempStats);
                    } else {
                        if (this.mode === 'macro') { ptfP = this.manualPortfolios.map(p=>({ name: p.name, cedant: p.cedant, count: parseInt(p.cases), is_new: p.is_new, current_team: null })); }
                        else { ptfP = this.portfolioStats; }
                    }

                    const totalCases = ptfP.reduce((s,p)=>s+p.count,0);
                    const totalLMs = teamsP.reduce((s,t)=>s+t.lm_count,0);
                    const ideal = Math.round(totalCases/totalLMs);

                    let promptContext = "";
                    if (userRefinementInstruction) {
                        promptContext = `MODALIT√Ä: MODIFICA MANUALE. STATO ATTUALE: vedi 'current_team'. RICHIESTA: "${userRefinementInstruction}". OBIETTIVO: Soddisfa la richiesta, mantieni il resto.`;
                    } else {
                        let modeInstr = (this.mode === 'rebalance') ? `MODALIT√Ä: RIBILANCIAMENTO. Assegna Nuovi portafogli, TASSATIVAMENTE limita gli spostamenti di pratiche attualmente gi√† assegnate SOLO SE necessario al ribilanciamento del numero di pratiche per LM o per accorpare banche cedenti sotto un solo team. In questo caso, tuttavia, DEVI limitarti a spostare SOLO i portafogli il cui numero sia sufficiente a eseguire il bilanciamento dei volumi di pratiche gestite e NON devi stravolgere il resto delle assegnazioni` 
                        : `MODALIT√Ä: ASSEGNAZIONE NUOVA.`;
                        promptContext = `${modeInstr} Target ~${ideal} pratiche/LM.`;
                    }

                    const prompt = `
                        Agisci come algoritmo di logistica NPL.
                        DATI: Pratiche Tot: ${totalCases}, LM Tot: ${totalLMs}
                        Teams: ${JSON.stringify(teamsP)}
                        Portafogli: ${JSON.stringify(ptfP)}
                        ${promptContext}
                        OUTPUT JSON ESCLUSIVAMENTE (senza testo):
                        { "assignments": [{ "portfolio_name": "Nome", "team_leader": "NomeLeader", "cases": 123, "is_new": true/false }], "reasoning": "Breve" }
                    `;

                    try {
                        const u = `https://generativelanguage.googleapis.com/v1beta/${this.selectedModel||'gemini-1.5-flash'}:generateContent?key=${this.apiKey}`;
                        const res = await fetch(u, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]}) });
                        const d = await res.json();
                        if(d.error) throw new Error(d.error.message);

                        let txt = d.candidates[0].content.parts[0].text.replace(/```json|```/g,'');
                        const jsonStr = txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1);
                        const ai = JSON.parse(jsonStr);
                        this.aiReasoning = ai.reasoning;

                        if (userRefinementInstruction) {
                            if (this.mode === 'macro') this.macroResults = []; else this.assignedRows = [];
                        }

                        if(this.mode === 'macro') {
                            this.macroResults = ai.assignments;
                        } else {
                            this.applyDetailAssignment(ai.assignments);
                            if (!userRefinementInstruction) this.applyRobinHoodLogic_Detail(ideal);
                        }
                        this.$nextTick(()=>this.renderChart());
                    } catch(e) { alert("Errore AI: "+e.message); }
                },
                
                resetResultsOnly() { this.macroResults=[]; this.assignedRows=[]; this.aiReasoning=''; this.rebalancingLog=''; if(this.chartInstance) { this.chartInstance.destroy(); this.chartInstance = null; } },

                applyDetailAssignment(assigns) {
                    const map = {}; assigns.forEach(a=>map[a.portfolio_name]=a.team_leader);
                    const tMap = {}; this.teams.forEach(t=>tMap[t.leader.toLowerCase().trim()]=t);
                    const grp = {};
                    this.rawRows.forEach(r => { if(!grp[r.ptf]) grp[r.ptf]=[]; grp[r.ptf].push(r); });

                    for(const [p, rows] of Object.entries(grp)) {
                        rows.sort((a,b)=>(String(a.status)||'').localeCompare(String(b.status)||''));
                        let leaderName = map[p] || '';
                        let targetT = tMap[leaderName.toLowerCase().trim()];
                        if(!targetT) targetT = this.teams[0]; 

                        let i = 0;
                        rows.forEach(r => {
                            let finalLM = '';
                            const teamChanged = (r.currentTeam && r.currentTeam !== targetT.leader);
                            if (this.mode === 'rebalance' && r.currentLM && !teamChanged) { finalLM = r.currentLM; } 
                            else { finalLM = targetT.managers[i % targetT.managers.length] || 'LM1'; }
                            this.assignedRows.push({ ...r, team: targetT.leader, assignedTo: finalLM, moved: teamChanged });
                            i++;
                        });
                    }
                },

                applyRobinHoodLogic_Detail(idealTarget) {
                    const stats = {};
                    this.teams.forEach(t => stats[t.leader] = { count: 0, managers: t.managers.length, obj: t });
                    this.assignedRows.forEach(r => { if(stats[r.team]) stats[r.team].count++; });

                    let rebalanced = false; let logs = [];
                    for(let loop=0; loop<5; loop++) {
                        let minT=null, maxT=null, minLoad=Infinity, maxLoad=-Infinity;
                        for(const k in stats) {
                            const load = stats[k].count / (stats[k].managers||1);
                            if(load < minLoad) { minLoad = load; minT = k; }
                            if(load > maxLoad) { maxLoad = load; maxT = k; }
                        }
                        const diff = maxLoad - minLoad;
                        if(diff < (idealTarget * 0.2)) break;
                        const amountToMove = Math.round((diff * stats[minT].managers) / 2);
                        if(amountToMove <= 0) break;

                        rebalanced = true;
                        logs.push(`Giro ${loop+1}: Spostate ${amountToMove} da ${maxT} a ${minT}`);
                        let moved = 0;
                        for(let i=0; i<this.assignedRows.length; i++) {
                            if(this.assignedRows[i].team === maxT) {
                                this.assignedRows[i].team = minT;
                                const tObj = stats[minT].obj;
                                this.assignedRows[i].assignedTo = tObj.managers[moved % tObj.managers.length] || 'LM1';
                                this.assignedRows[i].moved = true; 
                                stats[maxT].count--; stats[minT].count++; moved++;
                                if(moved >= amountToMove) break;
                            }
                        }
                    }
                    if(rebalanced) this.rebalancingLog = "Bilanciamento forzato attivo.\n" + logs.join("\n");
                },
                
                renderChart() {
                    const ctx = document.getElementById('resultChart').getContext('2d');
                    if (this.chartInstance) this.chartInstance.destroy();
                    const labels = this.teams.map(t => t.leader);
                    const dataV = [];
                    this.teams.forEach(t => {
                        let cnt = (this.mode==='macro') ? this.macroResults.filter(r=>r.team_leader===t.leader).reduce((s,x)=>s+x.cases,0) : this.assignedRows.filter(r=>r.team===t.leader).length;
                        dataV.push(Math.round(cnt/(t.managers.length||1)));
                    });
                    this.chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: labels, datasets: [{ label: 'Pratiche / LM', data: dataV, backgroundColor: '#6366f1' }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                    });
                },

                exportExcel() {
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(this.mode==='macro'?this.macroResults:this.assignedRows);
                    XLSX.utils.book_append_sheet(wb, ws, "Export_ADR");
                    XLSX.writeFile(wb, "ADR_Result.xlsx");
                }
            }
        }).mount('#app');
    });
</script>
</body>
</html>
